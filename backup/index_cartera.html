<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Trading</title>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f4f4f4;
        }

        .contenedor {
            max-width: 1100px;
            margin: auto;
            padding: 20px;
         }

        .bloque {
            background: #fff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }

        input, button {
            padding: 6px;
            font-size: 14px;
        }

        /* ===== INPUTS ===== */
        .input-group {
            display: inline-flex;
            align-items: center;
            margin-right: 6px;
        }

        .input-prefix,
        .input-suffix {
            background: #eee;
            padding: 6px 6px;
            border: 1px solid #ccc;
            font-size: 13px;
         }

        .input-prefix { border-right: none; }
        .input-suffix { border-left: none; }

        .input-group input {
            border-left: none;
            border-right: none;
            width: 70px;
            font-size: 13px;
        }

        /* ===== BOTONES ===== */
        .btn-analizar {
            background-color: #1f6feb;
            color: white;
            padding: 6px 10px;
            font-size: 13px;
        }

        /* NUEVO: Bot√≥n de backtest mejorado */
        .btn-backtest-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .btn-backtest-modal:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-backtest {
            background-color: #e0e0e0;
            color: #333;
            border: 1px solid #bbb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            padding: 6px 10px;
        }

        .btn-backtest:hover {
            background-color: #d5d5d5;
        }

        .btn-ibex {
            background-color: #2da44e;
            color: white;
         }

         .btn-continuo {
            background-color: #f0883e;
            color: white;
         }

        /* ===== LAYOUT ===== */
        .fila-analisis {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            flex-wrap: nowrap;
         }

        .col-botones {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-shrink: 0;
        }

        /* ===== ESC√ÅNER ===== */
        .botones-escaner {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 18px 0 25px 0;
        }

        /* ===== ALERTAS ===== */
        .alerta-compra {
            border-left: 6px solid #2e8b57;
            color: #1f5f3a;
            font-weight: bold;
        }

        .alerta-vigilancia {
            border-left: 6px solid #ff9800;
            color: #a05a00;
            font-weight: bold;
        }

        .alerta-bloque li {
            padding: 6px 10px;
            margin-bottom: 6px;
            border-radius: 4px;
            list-style: none;
        }

        .btn-pantallazo {
            margin-top: 12px;
            padding: 8px 14px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
        }

        .btn-pantallazo:hover {
            background-color: #2d86c9;
        }

        /* ===== GR√ÅFICO ===== */
        .bloque-grafico {
            text-align: center;
            /* max-width: 750px; */  /* Eliminado para usar ancho completo */
            margin-left: auto;
            margin-right: auto;
        }

        .bloque-grafico img {
            max-width: 100% !important;
            width: 100% !important;
            height: auto !important;
            display: block !important;
            margin: 0 auto !important;
        }

        /* ===== MODAL DE BACKTEST ===== */
        .modal-backtest {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content-backtest {
            background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
            margin: 3% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header-backtest {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header-backtest h2 {
            margin: 0;
            font-size: 24px;
        }

        .close-backtest {
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .close-backtest:hover {
            opacity: 1;
        }

        .loading-backtest {
            text-align: center;
            padding: 60px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .contenido-backtest {
            padding: 24px;
        }

        .estado-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 16px;
        }

        .estado-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .estado-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
        }

        .estado-danger {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .metricas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .metrica-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .metrica-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .metrica-value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }

        .seccion-tickers {
            margin: 24px 0;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .seccion-tickers h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ticker-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .ticker-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
        }

        .ticker-aprobado {
            background: #d4edda;
            color: #155724;
        }

        .ticker-neutro {
            background: #e2e3e5;
            color: #383d41;
        }

        .ticker-rechazado {
            background: #f8d7da;
            color: #721c24;
        }

        .ticker-excluido {
            background: #f8f9fa;
            color: #6c757d;
            font-size: 12px;
        }

        .recomendacion-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 24px;
        }

        .recomendacion-box h3 {
            margin: 0 0 12px 0;
        }

        .recomendacion-box ul {
            margin: 0;
            padding-left: 24px;
        }

        .recomendacion-box li {
            margin: 8px 0;
        }

        .config-info {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
            color: #6c757d;
        }

        /* ===== BOT√ìN GUARDAR RESULTADOS ===== */
        .btn-guardar-backtest {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
            width: 100%;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            transition: all 0.3s ease;
        }

        .btn-guardar-backtest:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }

        .btn-guardar-backtest:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>

<body>

<div class="contenedor">

<h1>Sistema de Trading</h1>

<form method="post" action="/" id="form-analizar">

    <div class="fila-analisis">

        <!-- Columna izquierda: botones -->
        <div class="col-botones">
            <button type="submit" name="analizar" value="1" class="btn-analizar">
                üîç Analizar valor
            </button>

            <button type="submit" name="backtest" value="1" class="btn-backtest">
                üìä Backtest (Fase 1)
            </button>

            <!-- NUEVO: Bot√≥n mejorado para modal -->
            <button type="button" id="btnBacktestModal" class="btn-backtest-modal">
                üìä Backtest Sistema
            </button>
        </div>

        <!-- Inputs alineados con Analizar -->
        <div class="input-group">
            <span class="input-prefix">Ej:</span>
            <input type="text" name="ticker" placeholder="IAG.MC" id="ticker">
        </div>

        <div class="input-group">
            <span class="input-prefix">Precio broker</span>
            <input type="number" name="precio_broker" id="precio_broker" placeholder="Precio broker (tiempo real)" step="0.01">
            <span class="input-suffix">‚Ç¨</span>
        </div>

        <div class="input-group">
            <span class="input-prefix">uds</span>
            <input type="number" name="acciones_manual" placeholder="Acciones" step="1">
        </div>

        <div class="input-group">
            <span class="input-prefix">Capital</span>
            <input type="number" name="capital_total" value="10000" step="100">
            <span class="input-suffix">‚Ç¨</span>
        </div>

        <div class="input-group">
            <span class="input-prefix">Riesgo</span>
            <input type="number" name="riesgo_pct" value="1" step="0.1" min="0.5" max="5">
            <span class="input-suffix">%</span>
        </div>

        <input type="hidden" name="ticker_forzado" id="ticker_forzado" value="">

    </div>

</form>


<div class="botones-escaner">
    <button type="button" onclick="abrirPopupIBEX()" class="btn-ibex">
        üá™üá∏ escanear IBEX 35
    </button>
    <button type="button" onclick="abrirPopupContinuo()" class="btn-continuo">
        üîÑ escanear M. Continuo
    </button>
</div>

<!-- BOT√ìN CARTERA -->
<div style="text-align: center; margin: 15px 0;">
    <a href="/cartera" style="
        display: inline-block;
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        transition: all 0.3s;
    " onmouseover="this.style.transform='translateY(-2px)'" 
       onmouseout="this.style.transform='translateY(0)'">
        üíº VER MI CARTERA
    </a>

</div>
{% if contexto_mercado %}
<div class="bloque" style="background-color:{{ contexto_mercado.color }}; color:white; font-weight:bold; text-align:center;">
    üö¶ {{ contexto_mercado.estado }} ‚Äî {{ contexto_mercado.texto }}
</div>
{% endif %}


{% if alertas_compra or alertas_vigilancia %}
<div class="bloque alerta-bloque">
    <h2 style="margin-top:0;">‚è∞ Alertas activas</h2>

    {% if alertas_compra %}
        <p style="font-weight:bold; color:#1f5f3a;">üìà Se√±ales de Compra:</p>
        <ul>
        {% for alerta in alertas_compra %}
            <li class="alerta-compra">
                <strong>{{ alerta.ticker }}</strong><br>
                {{ alerta.se√±al_texto }} | <strong>Entrada:</strong> {{ alerta.entrada }} ‚Ç¨
            </li>
        {% endfor %}
        </ul>
    {% endif %}

    {% if alertas_vigilancia %}
        <p style="font-weight:bold; color:#a05a00;">üëÄ En vigilancia:</p>
        <ul>
        {% for alerta in alertas_vigilancia %}
            <li class="alerta-vigilancia">
                <strong>{{ alerta.ticker }}</strong><br>
                {{ alerta.se√±al_texto }}
            </li>
        {% endfor %}
        </ul>
    {% endif %}
</div>
{% endif %}


{% if nombre_valor and precio_actual %}
<div class="bloque">
    <h2>{{ nombre_valor }} ({{ ticker }})</h2>

    <p>
        <strong>Precio actual:</strong>
        {{ "%.2f"|format(precio_actual) }} ‚Ç¨
    </p>

    {% if max_reciente is defined and min_reciente is defined and mm_actual is defined %}
    <div style="margin-top:10px; font-size:0.95em;">

        <p>
            <strong>M√°ximo reciente (20):</strong>
            {{ "%.2f"|format(max_reciente) }} ‚Ç¨
            {% if dist_max is defined %}
            <span style="font-weight:bold; color:{% if dist_max >= 0 %}green{% else %}red{% endif %};">
                ({{ "%.2f"|format(dist_max) }}%)
            </span>
            {% endif %}
        </p>

        <p>
            <strong>M√≠nimo reciente (20):</strong>
            {{ "%.2f"|format(min_reciente) }} ‚Ç¨
            {% if dist_min is defined %}
            <span style="font-weight:bold; color:{% if dist_min >= 0 %}green{% else %}red{% endif %};">
                ({{ "%.2f"|format(dist_min) }}%)
            </span>
            {% endif %}
        </p>

        <p>
            <strong>Media m√≥vil (20):</strong>
            {{ "%.2f"|format(mm_actual) }} ‚Ç¨
            {% if dist_mm is defined %}
            <span style="font-weight:bold; color:{% if dist_mm >= 0 %}green{% else %}red{% endif %};">
                ({{ "%.2f"|format(dist_mm) }}%)
            </span>
            {% endif %}
        </p>

    </div>
    {% endif %}
</div>
{% endif %}


<div id="pantallazo-trading">

{% if ticker and se√±al %}
<div class="bloque">
    <h2>Se√±al actual</h2>

    <p style="font-size:1.3em; font-weight:bold; 
              color:{% if se√±al == 'COMPRA' %}#2ecc71{% elif se√±al == 'VIGILANCIA' %}#ff9800{% else %}#e74c3c{% endif %};">
        {{ se√±al }}
    </p>
    
</div>
{% endif %}

{% if backtest_metricas %}
<div class="bloque" style="border:2px solid #9b59b6; background:#f8f3ff;">
    <h2>üìä Backtest - Fase 1 (Gesti√≥n por R)</h2>
    
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <div>
            <p><strong>Ticker:</strong> {{ ticker }}</p>
            <p><strong>Capital inicial:</strong> 10,000 ‚Ç¨</p>
        </div>
        <div style="text-align:right;">
            <p><strong>Capital final:</strong> 
                <span style="color:{% if backtest_capital_final > 10000 %}green{% else %}red{% endif %}; font-size:1.2em;">
                    {{ "%.2f"|format(backtest_capital_final) }} ‚Ç¨
                </span>
            </p>
            <p><strong>Retorno:</strong> 
                <span style="color:{% if backtest_metricas.retorno_pct > 0 %}green{% else %}red{% endif %}; font-weight:bold;">
                    {{ backtest_metricas.retorno_pct }}%
                </span>
            </p>
        </div>
    </div>

    
    <hr>
    
    <h3>üìà M√©tricas de Rendimiento</h3>
    <table style="width:100%; border-collapse:collapse;">
        <tr>
            <td style="padding:6px; border:1px solid #ddd;"><strong>Total operaciones:</strong></td>
            <td style="padding:6px; border:1px solid #ddd;">{{ backtest_metricas.total_trades }}</td>
            
            <td style="padding:6px; border:1px solid #ddd;"><strong>Porcentaje aciertos:</strong></td>
            <td style="padding:6px; border:1px solid #ddd; 
                       color:{% if backtest_metricas.win_rate_pct >= 40 %}green{% else %}red{% endif %};">
                {{ backtest_metricas.win_rate_pct }}%
            </td>
        </tr>
        <tr>
            <td style="padding:6px; border:1px solid #ddd;"><strong>Factor beneficio:</strong></td>
            <td style="padding:6px; border:1px solid #ddd;
                       color:{% if backtest_metricas.profit_factor >= 1.5 %}green{% elif backtest_metricas.profit_factor >= 1.0 %}orange{% else %}red{% endif %};">
                {{ backtest_metricas.profit_factor }}
            </td>
            
            <td style="padding:6px; border:1px solid #ddd;"><strong>Expectativa por operaci√≥n:</strong></td>
            <td style="padding:6px; border:1px solid #ddd;
                       color:{% if backtest_metricas.expectancy > 0 %}green{% else %}red{% endif %};">
                {{ "%.2f"|format(backtest_metricas.expectancy) }} ‚Ç¨
            </td>
        </tr>
        <tr>
            <td style="padding:6px; border:1px solid #ddd;"><strong>P√©rdida m√°xima:</strong></td>
            <td style="padding:6px; border:1px solid #ddd; color:red;">
                {{ backtest_metricas.max_drawdown_pct }}%
            </td>
            
            <td style="padding:6px; border:1px solid #ddd;"><strong>Riesgo Promedio:</strong></td>
            <td style="padding:6px; border:1px solid #ddd;">
                {{ backtest_metricas.r_promedio }}R
            </td>
        </tr>
        <tr>
            <td style="padding:6px; border:1px solid #ddd;"><strong>Ganancia promedio:</strong></td>
            <td style="padding:6px; border:1px solid #ddd; color:green;">
                {{ "%.2f"|format(backtest_metricas.avg_win) }} ‚Ç¨
            </td>
            
            <td style="padding:6px; border:1px solid #ddd;"><strong>P√©rdida promedio:</strong></td>
            <td style="padding:6px; border:1px solid #ddd; color:red;">
                {{ "%.2f"|format(backtest_metricas.avg_loss) }} ‚Ç¨
            </td>
        </tr>
    </table>

    {% if backtest_trades %}
    <hr>
    <h3>üîç √öltimos 10 Trades</h3>
    <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
            <thead>
                <tr style="background:#e0e0e0;">
                    <th style="padding:6px; border:1px solid #ccc;">Fecha</th>
                    <th style="padding:6px; border:1px solid #ccc;">Entrada</th>
                    <th style="padding:6px; border:1px solid #ccc;">Salida</th>
                    <th style="padding:6px; border:1px solid #ccc;">Beneficio</th>
                    <th style="padding:6px; border:1px solid #ccc;">R</th>
                    <th style="padding:6px; border:1px solid #ccc;">Gesti√≥n</th>
                    <th style="padding:6px; border:1px solid #ccc;">Setup</th>
                </tr>
            </thead>
            <tbody>
                {% for trade in backtest_trades[-10:] %}
                <tr>
                    <td style="padding:6px; border:1px solid #ccc; white-space:nowrap;">
                        {{ trade.fecha_entrada.strftime('%d/%m/%y') }}
                    </td>
                    <td style="padding:6px; border:1px solid #ccc;">
                        {{ "%.2f"|format(trade.entrada) }}‚Ç¨
                    </td>
                    <td style="padding:6px; border:1px solid #ccc;">
                        {{ "%.2f"|format(trade.salida) }}‚Ç¨
                    </td>
                    <td style="padding:6px; border:1px solid #ccc; 
                               color:{% if trade.beneficio > 0 %}green{% else %}red{% endif %}; 
                               font-weight:bold;">
                        {{ "%.2f"|format(trade.beneficio) }}‚Ç¨
                    </td>
                    <td style="padding:6px; border:1px solid #ccc;">
                        {{ "%.1f"|format(trade.R_alcanzado | default(0)) }}R
                    </td>
                    <td style="padding:6px; border:1px solid #ccc; font-size:0.85em;">
                        {{ trade.gestion }}
                    </td>
                    <td style="padding:6px; border:1px solid #ccc;">
                        {{ trade.setup_score }}/5
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <hr>
    <div style="background:#fffbe6; padding:10px; border-radius:4px; margin-top:10px;">
        <p style="margin:0; font-size:0.9em;">
            ‚ÑπÔ∏è <strong>Gesti√≥n por R implementada:</strong><br>
            ‚Ä¢ +1R ‚Üí Stop a Breakeven<br>
            ‚Ä¢ +2R ‚Üí Asegurar +1R<br>
            ‚Ä¢ +3R ‚Üí Trailing 5%
        </p>
    </div>
</div>
{% endif %}

{% if se√±al == "COMPRA" %}
<div class="bloque" style="border:2px solid #2ecc71; background:#ecf9f1;">
    <h2>üìà Plan de Trading</h2>

    <p><strong>Tipo de entrada:</strong> {{ tipo_entrada | default("N/A") }}</p>
    <p><strong>Entrada recomendada:</strong> {{ "%.2f"|format(entrada | default(0)) }} ‚Ç¨</p>
    <p><strong>Stop loss t√©cnico:</strong> {{ "%.2f"|format(stop | default(0)) }} ‚Ç¨</p>
    <p><strong>Objetivo t√©cnico:</strong> {{ "%.2f"|format(objetivo | default(0)) }} ‚Ç¨</p>

    <hr>

    <p><strong>Riesgo por acci√≥n:</strong> {{ "%.2f"|format(riesgo_por_accion | default(0)) }} ‚Ç¨</p>
    <p><strong>Beneficio potencial:</strong> {{ "%.2f"|format(beneficio_potencial | default(0)) }} ‚Ç¨</p>

    <p>
        <strong>Ratio Beneficio / Riesgo (R/R):</strong>
        <span style="font-weight:bold;
                     color:{% if rr and rr >= 2 %}green{% else %}red{% endif %};">
            {{ rr | default(0) }}
        </span>
    </p>

    <hr>

    <p><strong>Tama√±o de la posici√≥n:</strong> {{ acciones | default(0) }} acciones</p>
    <p><strong>Capital total:</strong> {{ "%.2f"|format(capital_total | default(0)) }} ‚Ç¨</p>
    <p><strong>Capital invertido:</strong> {{ "%.2f"|format(capital_invertido | default(0)) }} ‚Ç¨</p>
    <p><strong>Riesgo m√°ximo de la operaci√≥n:</strong> {{ "%.2f"|format(riesgo_operacion | default(0)) }} ‚Ç¨</p>

    <button type="button"
        onclick="guardarPantallazo()"
        class="btn-pantallazo">
        üì∏ Guardar pantallazo
    </button>

</div>
{% endif %}


{% if motivos and ticker %}
<div class="bloque">
    <h3>Condiciones t√©cnicas</h3>
    <ul>
        {% for m in motivos %}
            <li>{{ "‚úî" if m.ok else "‚ùå" }} {{ m.texto }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}


{% if se√±al == "COMPRA" and gestion_R %}
<div class="bloque" style="
    margin-top:15px;
    border:1px solid #3498db;
    border-radius:6px;
    padding:12px;
    background:#f4f9ff;
">
<h3>üìä Gesti√≥n din√°mica por R</h3>

    <p><strong>R:</strong> {{ "%.2f"|format(gestion_R.R) }} ‚Ç¨</p>

    <ul>
        {% for nivel in gestion_R.niveles %}
        <li>
            <strong>{{ nivel.nivel }}</strong> ‚Üí
            {{ nivel.precio }} ‚Ç¨ ‚Äî
            {{ nivel.accion }}
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}
</div>

{% if grafico_file and ticker %}
<div class="bloque bloque-grafico">
    <h2>Gr√°fico</h2>
    <img src="{{ url_for('static', filename=grafico_file.replace('static/','')) }}" alt="Gr√°fico de {{ ticker }}">
</div>
{% endif %}

</div> <!-- FIN contenedor -->

<!-- MODAL DE BACKTEST -->
<div id="modalBacktest" class="modal-backtest">
    <div class="modal-content-backtest">
        <!-- Header -->
        <div class="modal-header-backtest">
            <h2>üìä Resumen Ejecutivo - Sistema IBEX</h2>
            <span class="close-backtest">&times;</span>
        </div>
        
        <!-- Loading -->
        <div id="loadingBacktest" class="loading-backtest">
            <div class="spinner"></div>
            <p>Ejecutando backtest... ‚è≥</p>
        </div>
        
        <!-- Contenido -->
        <div id="contenidoBacktest" class="contenido-backtest" style="display: none;">
            <!-- Se llenar√° din√°micamente con JavaScript -->
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
function abrirPopupIBEX() {
    window.open(
        "/popup/ibex",
        "popup_ibex",
        "width=900,height=700,scrollbars=yes,resizable=yes"
    );
}

function abrirPopupContinuo() {
    window.open(
        "/popup/continuo",
        "popup_continuo",
        "width=900,height=700,scrollbars=yes,resizable=yes"
    );
    return false;
}

function guardarPantallazo() {
    const zona = document.getElementById("pantallazo-trading");

    if (!zona) {
        alert("No se encuentra la zona de pantallazo");
        return;
    }

    html2canvas(zona, { scale: 2 }).then(canvas => {
        const imagen = canvas.toDataURL("image/png");

        fetch("/guardar_pantallazo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                imagen: imagen,
                ticker: "{{ ticker }}"
            })
        })
        .then(r => r.text())
        .then(() => alert("‚úÖ Pantallazo guardado"))
        .catch(() => alert("‚ùå Error al guardar"));
    });
}
</script>

<script>
document.getElementById("form-analizar").addEventListener("submit", function () {
    const tickerInput = document.getElementById("ticker");
    const hidden = document.getElementById("ticker_forzado");

    if (tickerInput && hidden) {
        hidden.value = tickerInput.value;
    }
});
</script>

<!-- SCRIPT DEL MODAL DE BACKTEST -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('modalBacktest');
    const btn = document.getElementById('btnBacktestModal');
    const span = document.querySelector('.close-backtest');
    const loading = document.getElementById('loadingBacktest');
    const contenido = document.getElementById('contenidoBacktest');
    
    // Abrir modal
    btn.onclick = function() {
        modal.style.display = 'block';
        ejecutarBacktest();
    }
    
    // Cerrar modal
    span.onclick = function() {
        modal.style.display = 'none';
    }
    
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
    
    // Ejecutar backtest
    let ultimosResultados = null; // Variable global para almacenar los √∫ltimos resultados
    
    async function ejecutarBacktest() {
        loading.style.display = 'block';
        contenido.style.display = 'none';
        
        try {
            const response = await fetch('/api/backtest/ejecutar');
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Error desconocido');
            }
            
            ultimosResultados = data; // Guardar resultados globalmente
            mostrarResultados(data);
            
        } catch (error) {
            contenido.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #dc3545;">
                    <h3>‚ùå Error al ejecutar backtest</h3>
                    <p>${error.message}</p>
                </div>
            `;
        } finally {
            loading.style.display = 'none';
            contenido.style.display = 'block';
        }
    }
    
    // Mostrar resultados
    function mostrarResultados(data) {
        const html = `
            <!-- Estado del Sistema -->
            <div class="estado-badge estado-${data.estado.color}">
                ${data.estado.color === 'success' ? '‚úÖ' : data.estado.color === 'warning' ? '‚ö†Ô∏è' : '‚ùå'} 
                ${data.estado.texto}
            </div>
            
            <!-- M√©tricas Principales -->
            <div class="metricas-grid">
                <div class="metrica-card">
                    <div class="metrica-label">Expectativa</div>
                    <div class="metrica-value" style="color: ${data.metricas.expectancy >= 0.2 ? '#28a745' : '#dc3545'}">
                        ${data.metricas.expectancy >= 0 ? '+' : ''}${data.metricas.expectancy}R
                    </div>
                </div>
                <div class="metrica-card">
                    <div class="metrica-label">Porcentaje aciertos</div>
                    <div class="metrica-value">${data.metricas.winrate}%</div>
                </div>
                <div class="metrica-card">
                    <div class="metrica-label">P√©rdida m√°xima</div>
                    <div class="metrica-value">${data.metricas.max_dd}%</div>
                </div>
                <div class="metrica-card">
                    <div class="metrica-label">Total operaciones</div>
                    <div class="metrica-value">${data.metricas.total_trades}</div>
                </div>
            </div>
            
            <!-- Tickers Aprobados -->
            ${data.tickers.aprobados.length > 0 ? `
            <div class="seccion-tickers">
                <h3>‚úÖ Tickers Aprobados (${data.tickers.aprobados.length}) - Operar prioritariamente</h3>
                <div class="ticker-list">
                    ${data.tickers.aprobados.map(t => `
                        <span class="ticker-badge ticker-aprobado">
                            ${t.nombre} (${t.retorno >= 0 ? '+' : ''}${t.retorno}%)
                        </span>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- Tickers Neutros -->
            ${data.tickers.neutros.length > 0 ? `
            <div class="seccion-tickers">
                <h3>‚ö™ Tickers Neutros (${data.tickers.neutros.length}) - Operar con cautela</h3>
                <div class="ticker-list">
                    ${data.tickers.neutros.map(t => `
                        <span class="ticker-badge ticker-neutro">
                            ${t.nombre} (${t.retorno >= 0 ? '+' : ''}${t.retorno}%)
                        </span>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- Tickers Rechazados -->
            ${data.tickers.rechazados.length > 0 ? `
            <div class="seccion-tickers">
                <h3>‚ùå Tickers Rechazados (${data.tickers.rechazados.length}) - NO operar</h3>
                <div class="ticker-list">
                    ${data.tickers.rechazados.map(t => `
                        <span class="ticker-badge ticker-rechazado">
                            ${t.nombre} (${t.retorno}%)
                        </span>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- Tickers Excluidos -->
            ${data.tickers.excluidos.length > 0 ? `
            <div class="seccion-tickers">
                <h3>üö´ Excluidos por Volatilidad (${data.tickers.excluidos.length})</h3>
                <div class="ticker-list">
                    ${data.tickers.excluidos.map(t => `
                        <span class="ticker-badge ticker-excluido">
                            ${t.nombre} (${t.vol}% vol)
                        </span>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- Recomendaci√≥n -->
            <div class="recomendacion-box">
                <h3>üí° ${data.recomendacion.titulo}</h3>
                <ul>
                    ${data.recomendacion.acciones.map(accion => `<li>${accion}</li>`).join('')}
                </ul>
            </div>
            
            <!-- Configuraci√≥n -->
            <div class="config-info">
                ‚öôÔ∏è Configuraci√≥n: Target ${data.config.target} | Break-even ${data.config.breakeven} | 
                Riesgo ${data.config.riesgo} | Filtro volatilidad ${data.config.filtro_vol}
            </div>
            
            <!-- Bot√≥n Guardar -->
            <button id="btnGuardarBacktestPantalla" class="btn-guardar-backtest">
                üì∏ Guardar Backtest
            </button>
        `;
        
        contenido.innerHTML = html;
    }
        
// Delegaci√≥n de eventos para bot√≥n din√°mico (GUARDAR BACKTEST)
document.addEventListener("click", function (e) {

    if (e.target && e.target.id === "btnGuardarBacktestPantalla") {

        const zona = document.getElementById("contenidoBacktest");

        if (!zona) {
            alert("No se encuentra el contenido del backtest");
            return;
        }

        e.target.disabled = true;
        e.target.textContent = "‚è≥ Guardando...";

        html2canvas(zona, { scale: 2 }).then(canvas => {
            const imagen = canvas.toDataURL("image/png");

            fetch("/guardar_pantallazo", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    imagen: imagen,
                    ticker: "BACKTEST_SISTEMA"
                })
            })
            .then(() => {
                alert("‚úÖ Backtest guardado");
                e.target.textContent = "üì∏ Guardar Backtest";
                e.target.disabled = false;
            })
            .catch(() => {
                alert("‚ùå Error al guardar");
                e.target.textContent = "üì∏ Guardar Backtest";
                e.target.disabled = false;
            });
        });
    }
});

});
</script>

</body>
</html>
