<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cartera Posicional</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .back-link {
            display: inline-block;
            margin-bottom: 10px;
            color: white;
            text-decoration: none;
            font-size: 0.9em;
        }
        .back-link:hover { text-decoration: underline; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        h1 { color: #1e3c72; margin-bottom: 15px; font-size: 1.4em; }
        h2 { color: #1e3c72; margin: 16px 0 10px 0; font-size: 1.1em; }
        
        .form-nueva { display: none; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-top: 15px; }
        .form-nueva.activo { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 0.85em; }
        input, select, textarea {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #1e3c72; }
        textarea { resize: vertical; min-height: 60px; font-family: inherit; }
        
        .selector-ticker { margin-bottom: 15px; }
        .btn-mostrar {
            padding: 10px 20px;
            background: #1e3c72;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .btn-mostrar:hover { background: #2a5298; }
        
        .calculos-auto {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #1e3c72;
        }
        .calculos-auto h4 { margin: 0 0 10px 0; color: #1e3c72; font-size: 0.95em; }
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        .calc-item { }
        .calc-label { font-size: 0.75em; color: #666; display: block; margin-bottom: 2px; }
        .calc-valor { font-size: 1.1em; font-weight: bold; color: #1e3c72; display: block; }
        
        .botones-form { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
        .btn-add {
            padding: 10px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
        }
        .btn-add:hover { background: #218838; }
        .btn-cancelar {
            padding: 10px 24px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .btn-cancelar:hover { background: #5a6268; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 18px;
        }
        .stat-card {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px 8px;
            border-left: 3px solid #1e3c72;
            text-align: center;
        }
        .stat-label { color: #666; font-size: 0.75em; margin-bottom: 4px; }
        .stat-value { font-size: 1.3em; font-weight: bold; color: #1e3c72; }
        .posiciones-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        .posiciones-table th {
            background: #1e3c72;
            color: white;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8em;
        }
        .posiciones-table td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            font-size: 0.85em;
        }
        .posiciones-table tr:hover { background: #f8f9fa; }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .badge-inicial { background: #e3f2fd; color: #1976d2; }
        .badge-protegido { background: #fff3cd; color: #856404; }
        .badge-trailing { background: #d4edda; color: #155724; }
        .positive { color: #28a745; font-weight: 600; }
        .negative { color: #dc3545; font-weight: 600; }
        .empty-state { text-align: center; padding: 35px; color: #666; }
        .empty-state h3 { margin-bottom: 6px; color: #999; font-size: 1.1em; }
        .alert { padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 0.9em; }
        .alert-error { background: #fee; border-left: 3px solid #c33; color: #c33; }
        .alert-success { background: #d4edda; border-left: 3px solid #28a745; color: #155724; }
        .btn-refresh {
            padding: 7px 14px;
            background: #1e3c72;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            margin-bottom: 12px;
        }
        .btn-refresh:hover { background: #2a5298; }
        .btn-delete {
            padding: 4px 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
        }
        .btn-delete:hover { background: #c82333; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/posicional" class="back-link">‚Üê Volver</a>
        
        <div class="card">
            <h1>üíº Cartera Posicional</h1>
            
            <button class="btn-mostrar" onclick="toggleFormulario()">‚ûï Nueva Posici√≥n</button>
            
            <div id="formNueva" class="form-nueva">
                <h3 style="margin-bottom: 15px; color: #1e3c72;">üìù A√±adir Posici√≥n Manual</h3>
                
                <div class="selector-ticker">
                    <label for="ticker">Ticker:</label>
                    <select id="ticker" onchange="tickerSeleccionado()">
                        <option value="">-- Selecciona un valor --</option>
                        <optgroup label="IBEX 35">
                            {% for t in ibex_35 %}
                            <option value="{{ t }}">{{ t }}</option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Mercado Continuo">
                            {% for t in mercado_continuo %}
                            <option value="{{ t }}">{{ t }}</option>
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fecha_entrada">Fecha entrada:</label>
                        <input type="date" id="fecha_entrada" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="precio_entrada">Precio entrada:</label>
                        <input type="number" id="precio_entrada" step="0.01" min="0.01" required onchange="calcularAutomatico()">
                    </div>
                    
                    <div class="form-group">
                        <label for="stop_loss">Stop loss:</label>
                        <input type="number" id="stop_loss" step="0.01" min="0.01" required onchange="calcularAutomatico()">
                    </div>
                    
                    <div class="form-group">
                        <label for="acciones">Acciones:</label>
                        <input type="number" id="acciones" min="1" required onchange="calcularAutomatico()">
                    </div>
                </div>
                
                <div id="calculos" class="calculos-auto" style="display: none;">
                    <h4>üìä C√ÅLCULOS AUTOM√ÅTICOS</h4>
                    <div class="calc-grid">
                        <div class="calc-item">
                            <span class="calc-label">Riesgo/acci√≥n</span>
                            <span class="calc-valor" id="calc-riesgo">-</span>
                        </div>
                        <div class="calc-item">
                            <span class="calc-label">Riesgo %</span>
                            <span class="calc-valor" id="calc-riesgo-pct">-</span>
                        </div>
                        <div class="calc-item">
                            <span class="calc-label">1R</span>
                            <span class="calc-valor" id="calc-1r">-</span>
                        </div>
                        <div class="calc-item">
                            <span class="calc-label">2R</span>
                            <span class="calc-valor" id="calc-2r">-</span>
                        </div>
                        <div class="calc-item">
                            <span class="calc-label">Capital invertido</span>
                            <span class="calc-valor" id="calc-capital">-</span>
                        </div>
                        <div class="calc-item">
                            <span class="calc-label">Riesgo m√°ximo</span>
                            <span class="calc-valor" id="calc-riesgo-max">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notas">Notas:</label>
                    <textarea id="notas" placeholder="Motivo de la operaci√≥n..."></textarea>
                </div>
                
                <div id="mensaje"></div>
                
                <div class="botones-form">
                    <button class="btn-cancelar" onclick="toggleFormulario()">Cancelar</button>
                    <button class="btn-add" onclick="guardarPosicion()">üíæ Guardar</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            {% if error %}
            <div class="alert alert-error">‚ùå {{ error }}</div>
            {% endif %}
            
            <button class="btn-refresh" onclick="location.reload()">üîÑ Actualizar</button>
            
            {% if cartera %}
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Posiciones</div>
                    <div class="stat-value">{{ cartera.posiciones|length }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Disponible</div>
                    <div class="stat-value">{{ "{:,.0f}".format(cartera.capital_disponible) }}‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Invertido</div>
                    <div class="stat-value">{{ "{:,.0f}".format(cartera.capital_invertido|default(0)) }}‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Exposici√≥n</div>
                    <div class="stat-value">
                        {% if cartera.capital_disponible > 0 %}
                        {{ "{:.1f}".format((cartera.capital_invertido|default(0)) / cartera.capital_disponible * 100) }}%
                        {% else %}
                        0%
                        {% endif %}
                    </div>
                </div>
            </div>
            
            {% if cartera.posiciones %}
            <h2>üìä Posiciones Actuales</h2>
            <table class="posiciones-table">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>Entrada</th>
                        <th>Stop</th>
                        <th>Acciones</th>
                        <th>Estado</th>
                        <th>R</th>
                        <th>Fecha</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pos in cartera.posiciones %}
                    <tr>
                        <td><strong>{{ pos.ticker }}</strong></td>
                        <td>{{ "{:.2f}".format(pos.precio_entrada) }}‚Ç¨</td>
                        <td>{{ "{:.2f}".format(pos.stop_loss) }}‚Ç¨</td>
                        <td>{{ pos.acciones }}</td>
                        <td><span class="badge badge-{{ pos.estado|lower }}">{{ pos.estado }}</span></td>
                        <td class="{% if pos.r_actual > 0 %}positive{% elif pos.r_actual < 0 %}negative{% endif %}">
                            {{ "{:+.2f}".format(pos.r_actual) }}R
                        </td>
                        <td>{{ pos.fecha_entrada[:10] }}</td>
                        <td>
                            <button class="btn-delete" onclick="eliminarPosicion('{{ pos.ticker }}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <h3>üî≠ No hay posiciones</h3>
                <p>A√±ade posiciones usando el bot√≥n de arriba</p>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>
    
    <script>
        function toggleFormulario() {
            var form = document.getElementById('formNueva');
            if (form.classList.contains('activo')) {
                form.classList.remove('activo');
            } else {
                form.classList.add('activo');
            }
        }
        
        function tickerSeleccionado() {
            var ticker = document.getElementById('ticker').value;
            if (ticker) {
                document.getElementById('fecha_entrada').valueAsDate = new Date();
            }
        }
        
        function calcularAutomatico() {
            var entrada = parseFloat(document.getElementById('precio_entrada').value);
            var stop = parseFloat(document.getElementById('stop_loss').value);
            var acciones = parseInt(document.getElementById('acciones').value);
            
            if (!entrada || !stop || !acciones) return;
            
            var riesgo = entrada - stop;
            var riesgoPct = (riesgo / entrada) * 100;
            var capitalInvertido = entrada * acciones;
            var riesgoMax = riesgo * acciones;
            var r1 = entrada + riesgo;
            var r2 = entrada + (riesgo * 2);
            
            document.getElementById('calc-riesgo').textContent = riesgo.toFixed(2) + ' ‚Ç¨';
            document.getElementById('calc-riesgo-pct').textContent = riesgoPct.toFixed(1) + '%';
            document.getElementById('calc-1r').textContent = r1.toFixed(2) + ' ‚Ç¨';
            document.getElementById('calc-2r').textContent = r2.toFixed(2) + ' ‚Ç¨';
            document.getElementById('calc-capital').textContent = capitalInvertido.toFixed(2) + ' ‚Ç¨';
            document.getElementById('calc-riesgo-max').textContent = riesgoMax.toFixed(2) + ' ‚Ç¨';
            
            document.getElementById('calculos').style.display = 'block';
        }
        
        function guardarPosicion() {
            var ticker = document.getElementById('ticker').value;
            var fecha = document.getElementById('fecha_entrada').value;
            var entrada = parseFloat(document.getElementById('precio_entrada').value);
            var stop = parseFloat(document.getElementById('stop_loss').value);
            var acciones = parseInt(document.getElementById('acciones').value);
            var notas = document.getElementById('notas').value;
            var mensaje = document.getElementById('mensaje');
            
            if (!ticker || !fecha || !entrada || !stop || !acciones) {
                mensaje.innerHTML = '<div class="alert alert-error">‚ùå Completa todos los campos</div>';
                return;
            }
            
            mensaje.innerHTML = '<div style="text-align: center; padding: 10px;">üíæ Guardando...</div>';
            
            fetch('/posicional/api/cartera/a√±adir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ticker: ticker,
                    fecha_entrada: fecha,
                    precio_entrada: entrada,
                    stop_loss: stop,
                    acciones: acciones,
                    notas: notas
                })
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    mensaje.innerHTML = '<div class="alert alert-success">‚úÖ ' + data.mensaje + '</div>';
                    setTimeout(function() { location.reload(); }, 1500);
                } else {
                    mensaje.innerHTML = '<div class="alert alert-error">‚ùå ' + data.error + '</div>';
                }
            })
            .catch(function(error) {
                mensaje.innerHTML = '<div class="alert alert-error">‚ùå Error: ' + error.message + '</div>';
            });
        }
        
        function eliminarPosicion(ticker) {
            if (!confirm('¬øEliminar ' + ticker + '?')) return;
            
            fetch('/posicional/api/cartera/eliminar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker: ticker })
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(function(error) { alert('Error: ' + error.message); });
        }
    </script>
</body>
</html>
